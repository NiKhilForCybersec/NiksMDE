<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Hunting Queries | MDE Ultimate Guide</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="mobile-menu-btn" aria-label="Toggle menu">‚ò∞</button>
            <a href="index.html" class="logo">
                <div class="logo-icon">MDE</div>
                <div class="logo-text"><span>MDE</span> Ultimate Guide</div>
            </a>
        </div>
        <div class="search-container">
            <button class="search-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <span>Search documentation...</span>
                <span class="search-shortcut"><kbd>‚åò</kbd><kbd>K</kbd></span>
            </button>
        </div>
        <div class="header-right">
            <a href="12-2-interview-questions.html" class="header-link">Interview Prep</a>
            <a href="5-3-kql-fundamentals.html" class="header-link">KQL Guide</a>
        </div>
    </header>

    <div class="sidebar-overlay"></div>
    <aside class="sidebar"></aside>

    <main class="main-content">
        <div class="content-wrapper">
            <div class="overview-box">
                <h4>üéØ What This Page Covers</h4>
                <p>Ready-to-use KQL hunting queries for network-based threat detection. Hunt for C2 communication, data exfiltration, lateral movement, and suspicious network behaviors.</p>
            </div>

            <h1>Network Hunting Queries</h1>

            <p>Network activity analysis is critical for detecting command and control, data exfiltration, and lateral movement. These queries help identify suspicious network patterns.</p>

            <h2>C2 Communication Detection</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - C2 Indicators</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Connections to non-standard ports</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RemotePort <span class="operator">!</span><span class="function">in</span> (<span class="number">80</span>, <span class="number">443</span>, <span class="number">22</span>, <span class="number">21</span>, <span class="number">25</span>, <span class="number">53</span>, <span class="number">123</span>, <span class="number">389</span>, <span class="number">636</span>, <span class="number">445</span>, <span class="number">3389</span>)
<span class="operator">|</span> <span class="keyword">where</span> RemoteIPType <span class="operator">==</span> <span class="string">"Public"</span>
<span class="operator">|</span> <span class="keyword">summarize</span> 
    ConnectionCount = <span class="function">count</span>(),
    Devices = <span class="function">dcount</span>(DeviceName)
    <span class="keyword">by</span> RemoteIP, RemotePort
<span class="operator">|</span> <span class="keyword">where</span> ConnectionCount <span class="operator">></span> <span class="number">10</span>
<span class="operator">|</span> <span class="keyword">order by</span> ConnectionCount <span class="keyword">desc</span>

<span class="comment">// Beaconing detection (regular interval connections)</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">24</span>h)
<span class="operator">|</span> <span class="keyword">where</span> RemoteIPType <span class="operator">==</span> <span class="string">"Public"</span>
<span class="operator">|</span> <span class="keyword">summarize</span> 
    Connections = <span class="function">make_list</span>(Timestamp),
    Count = <span class="function">count</span>()
    <span class="keyword">by</span> DeviceName, RemoteIP
<span class="operator">|</span> <span class="keyword">where</span> Count <span class="operator">></span> <span class="number">20</span>
<span class="operator">|</span> <span class="keyword">extend</span> Intervals = <span class="function">array_length</span>(Connections)
<span class="operator">|</span> <span class="keyword">where</span> Intervals <span class="operator">></span> <span class="number">20</span>

<span class="comment">// Suspicious processes making external connections</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RemoteIPType <span class="operator">==</span> <span class="string">"Public"</span>
<span class="operator">|</span> <span class="keyword">where</span> InitiatingProcessFileName <span class="function">in~</span> (
    <span class="string">"powershell.exe"</span>, <span class="string">"cmd.exe"</span>, <span class="string">"wscript.exe"</span>, 
    <span class="string">"cscript.exe"</span>, <span class="string">"mshta.exe"</span>, <span class="string">"rundll32.exe"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RemoteIP, RemotePort, RemoteUrl,
         InitiatingProcessFileName, InitiatingProcessCommandLine</code></pre>
                </div>
            </div>

            <h2>Data Exfiltration Detection</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Exfiltration Indicators</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Connections to file sharing sites</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RemoteUrl <span class="function">has_any</span> (
    <span class="string">"dropbox.com"</span>, <span class="string">"mega.nz"</span>, <span class="string">"wetransfer.com"</span>,
    <span class="string">"sendspace.com"</span>, <span class="string">"pastebin.com"</span>, <span class="string">"anonfiles.com"</span>,
    <span class="string">"transfer.sh"</span>, <span class="string">"file.io"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RemoteUrl, 
         InitiatingProcessFileName, AccountName

<span class="comment">// Large outbound data transfers</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">24</span>h)
<span class="operator">|</span> <span class="keyword">where</span> RemoteIPType <span class="operator">==</span> <span class="string">"Public"</span>
<span class="operator">|</span> <span class="keyword">where</span> ActionType <span class="operator">==</span> <span class="string">"ConnectionSuccess"</span>
<span class="operator">|</span> <span class="keyword">summarize</span> 
    TotalConnections = <span class="function">count</span>(),
    UniqueDestinations = <span class="function">dcount</span>(RemoteIP)
    <span class="keyword">by</span> DeviceName, InitiatingProcessFileName
<span class="operator">|</span> <span class="keyword">where</span> TotalConnections <span class="operator">></span> <span class="number">100</span>
<span class="operator">|</span> <span class="keyword">order by</span> TotalConnections <span class="keyword">desc</span>

<span class="comment">// DNS exfiltration (long DNS queries)</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RemotePort <span class="operator">==</span> <span class="number">53</span>
<span class="operator">|</span> <span class="keyword">where</span> <span class="function">strlen</span>(RemoteUrl) <span class="operator">></span> <span class="number">50</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RemoteUrl, 
         InitiatingProcessFileName</code></pre>
                </div>
            </div>

            <h2>Lateral Movement Detection</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Lateral Movement</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// SMB connections (potential lateral movement)</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RemotePort <span class="operator">==</span> <span class="number">445</span>
<span class="operator">|</span> <span class="keyword">where</span> RemoteIPType <span class="operator">==</span> <span class="string">"Private"</span>
<span class="operator">|</span> <span class="keyword">summarize</span> 
    TargetCount = <span class="function">dcount</span>(RemoteIP),
    Targets = <span class="function">make_set</span>(RemoteIP)
    <span class="keyword">by</span> DeviceName, AccountName
<span class="operator">|</span> <span class="keyword">where</span> TargetCount <span class="operator">></span> <span class="number">5</span>
<span class="operator">|</span> <span class="keyword">order by</span> TargetCount <span class="keyword">desc</span>

<span class="comment">// RDP connections to multiple hosts</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RemotePort <span class="operator">==</span> <span class="number">3389</span>
<span class="operator">|</span> <span class="keyword">summarize</span> 
    DestinationCount = <span class="function">dcount</span>(RemoteIP)
    <span class="keyword">by</span> DeviceName, AccountName
<span class="operator">|</span> <span class="keyword">where</span> DestinationCount <span class="operator">></span> <span class="number">3</span>

<span class="comment">// WinRM connections (remote PowerShell)</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RemotePort <span class="function">in</span> (<span class="number">5985</span>, <span class="number">5986</span>)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RemoteIP, 
         InitiatingProcessFileName, AccountName

<span class="comment">// PsExec network activity</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> InitiatingProcessFileName <span class="operator">=~</span> <span class="string">"psexec.exe"</span> 
    <span class="keyword">or</span> InitiatingProcessFileName <span class="operator">=~</span> <span class="string">"psexesvc.exe"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RemoteIP, 
         InitiatingProcessCommandLine</code></pre>
                </div>
            </div>

            <h2>Suspicious External Connections</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - External Threats</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Connections to newly registered domains</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> <span class="function">isnotempty</span>(RemoteUrl)
<span class="operator">|</span> <span class="keyword">summarize</span> Count = <span class="function">count</span>() <span class="keyword">by</span> RemoteUrl, DeviceName
<span class="operator">|</span> <span class="keyword">where</span> Count <span class="operator"><</span> <span class="number">3</span>  <span class="comment">// Rare connections</span>

<span class="comment">// Connections during off-hours</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RemoteIPType <span class="operator">==</span> <span class="string">"Public"</span>
<span class="operator">|</span> <span class="keyword">extend</span> Hour = <span class="function">hourofday</span>(Timestamp)
<span class="operator">|</span> <span class="keyword">where</span> Hour <span class="operator"><</span> <span class="number">6</span> <span class="keyword">or</span> Hour <span class="operator">></span> <span class="number">22</span>
<span class="operator">|</span> <span class="keyword">summarize</span> Count = <span class="function">count</span>() <span class="keyword">by</span> DeviceName, RemoteIP
<span class="operator">|</span> <span class="keyword">where</span> Count <span class="operator">></span> <span class="number">10</span>

<span class="comment">// Tor exit node connections</span>
<span class="keyword">let</span> TorExitNodes = <span class="function">dynamic</span>([<span class="string">"known_tor_ips"</span>]);  <span class="comment">// Add known Tor IPs</span>
<span class="variable">DeviceNetworkEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RemoteIP <span class="function">in</span> (TorExitNodes)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RemoteIP, InitiatingProcessFileName</code></pre>
                </div>
            </div>

            <div class="callout tip">
                <div class="callout-icon">üí°</div>
                <div class="callout-content">
                    <h5>Network Hunting Tips</h5>
                    <ul>
                        <li><strong>Baseline normal traffic</strong> before hunting for anomalies</li>
                        <li><strong>Correlate with process data</strong> for context</li>
                        <li><strong>Check threat intel</strong> for suspicious IPs/domains</li>
                        <li><strong>Monitor port 443</strong> - encrypted C2 is common</li>
                    </ul>
                </div>
            </div>

            <!-- Interview Tips -->
            <div class="interview-tips">
                <h3>üí° Key Interview Points</h3>
                <ul>
                    <li><strong>C2 indicators</strong>: Non-standard ports, beaconing, script engines connecting out</li>
                    <li><strong>Exfiltration</strong>: File sharing sites, large transfers, DNS tunneling</li>
                    <li><strong>Lateral movement</strong>: SMB (445), RDP (3389), WinRM (5985/5986)</li>
                    <li><strong>Key fields</strong>: RemoteIP, RemotePort, RemoteUrl, InitiatingProcess*</li>
                </ul>
            </div>

            <nav class="page-nav">
                <a href="5-5-hunting-queries-processes.html" class="page-nav-link prev">
                    <span class="page-nav-label">‚Üê Previous</span>
                    <span class="page-nav-title">Process Hunting</span>
                </a>
                <a href="5-7-hunting-queries-persistence.html" class="page-nav-link next">
                    <span class="page-nav-label">Next ‚Üí</span>
                    <span class="page-nav-title">Persistence Hunting</span>
                </a>
            </nav>
        </div>
    </main>

    <div class="search-modal">
        <div class="search-modal-content">
            <div class="search-modal-input-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-modal-input" placeholder="Search pages..." autofocus>
                <button class="search-modal-close">ESC</button>
            </div>
            <div class="search-results"></div>
        </div>
    </div>
    <script src="main.js"></script>
</body>
</html>
