<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistence Hunting Queries | MDE Ultimate Guide</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="mobile-menu-btn" aria-label="Toggle menu">‚ò∞</button>
            <a href="index.html" class="logo">
                <div class="logo-icon">MDE</div>
                <div class="logo-text"><span>MDE</span> Ultimate Guide</div>
            </a>
        </div>
        <div class="search-container">
            <button class="search-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <span>Search documentation...</span>
                <span class="search-shortcut"><kbd>‚åò</kbd><kbd>K</kbd></span>
            </button>
        </div>
        <div class="header-right">
            <a href="12-2-interview-questions.html" class="header-link">Interview Prep</a>
            <a href="5-3-kql-fundamentals.html" class="header-link">KQL Guide</a>
        </div>
    </header>

    <div class="sidebar-overlay"></div>
    <aside class="sidebar"></aside>

    <main class="main-content">
        <div class="content-wrapper">
            <div class="overview-box">
                <h4>üéØ What This Page Covers</h4>
                <p>Ready-to-use KQL hunting queries for persistence mechanism detection. Hunt for registry-based persistence, scheduled tasks, services, startup folders, and other persistence techniques.</p>
            </div>

            <h1>Persistence Hunting Queries</h1>

            <p>Persistence allows attackers to maintain access across reboots. These queries help identify common persistence mechanisms attackers use to survive system restarts.</p>

            <h2>Registry Run Keys</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Registry Persistence</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Run key modifications</span>
<span class="variable">DeviceRegistryEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RegistryKey <span class="function">has_any</span> (
    <span class="string">"\\CurrentVersion\\Run"</span>,
    <span class="string">"\\CurrentVersion\\RunOnce"</span>,
    <span class="string">"\\CurrentVersion\\RunServices"</span>
)
<span class="operator">|</span> <span class="keyword">where</span> ActionType <span class="operator">==</span> <span class="string">"RegistryValueSet"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RegistryKey, RegistryValueName, 
         RegistryValueData, InitiatingProcessFileName, AccountName

<span class="comment">// Winlogon persistence (Shell, Userinit)</span>
<span class="variable">DeviceRegistryEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RegistryKey <span class="function">has</span> <span class="string">"Winlogon"</span>
<span class="operator">|</span> <span class="keyword">where</span> RegistryValueName <span class="function">in~</span> (<span class="string">"Shell"</span>, <span class="string">"Userinit"</span>, <span class="string">"Notify"</span>)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RegistryKey, RegistryValueName,
         RegistryValueData, InitiatingProcessFileName

<span class="comment">// Image File Execution Options (debugger hijack)</span>
<span class="variable">DeviceRegistryEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RegistryKey <span class="function">has</span> <span class="string">"Image File Execution Options"</span>
<span class="operator">|</span> <span class="keyword">where</span> RegistryValueName <span class="operator">=~</span> <span class="string">"Debugger"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RegistryKey, RegistryValueData,
         InitiatingProcessFileName</code></pre>
                </div>
            </div>

            <h2>Scheduled Tasks</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Scheduled Task Persistence</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Scheduled task creation via schtasks</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="operator">=~</span> <span class="string">"schtasks.exe"</span>
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has</span> <span class="string">"/create"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName,
         InitiatingProcessFileName

<span class="comment">// Scheduled task XML files created</span>
<span class="variable">DeviceFileEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FolderPath <span class="function">has</span> <span class="string">"\\Windows\\System32\\Tasks"</span>
<span class="operator">|</span> <span class="keyword">where</span> ActionType <span class="operator">==</span> <span class="string">"FileCreated"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, FolderPath,
         InitiatingProcessFileName, InitiatingProcessCommandLine

<span class="comment">// Suspicious scheduled task actions</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="operator">=~</span> <span class="string">"schtasks.exe"</span>
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (
    <span class="string">"powershell"</span>, <span class="string">"cmd /c"</span>, <span class="string">"wscript"</span>, <span class="string">"cscript"</span>,
    <span class="string">"http"</span>, <span class="string">"\\Temp\\"</span>, <span class="string">"\\AppData\\"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName</code></pre>
                </div>
            </div>

            <h2>Services</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Service Persistence</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Service creation via sc.exe</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="operator">=~</span> <span class="string">"sc.exe"</span>
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has</span> <span class="string">"create"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName,
         InitiatingProcessFileName

<span class="comment">// Service registry modifications</span>
<span class="variable">DeviceRegistryEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RegistryKey <span class="function">has</span> <span class="string">"\\Services\\"</span>
<span class="operator">|</span> <span class="keyword">where</span> RegistryValueName <span class="function">in~</span> (<span class="string">"ImagePath"</span>, <span class="string">"ServiceDll"</span>)
<span class="operator">|</span> <span class="keyword">where</span> ActionType <span class="operator">==</span> <span class="string">"RegistryValueSet"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RegistryKey, RegistryValueData,
         InitiatingProcessFileName

<span class="comment">// Services running from suspicious locations</span>
<span class="variable">DeviceRegistryEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RegistryKey <span class="function">has</span> <span class="string">"\\Services\\"</span>
<span class="operator">|</span> <span class="keyword">where</span> RegistryValueName <span class="operator">=~</span> <span class="string">"ImagePath"</span>
<span class="operator">|</span> <span class="keyword">where</span> RegistryValueData <span class="function">has_any</span> (<span class="string">"\\Temp\\"</span>, <span class="string">"\\AppData\\"</span>, <span class="string">"\\Users\\"</span>)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RegistryKey, RegistryValueData</code></pre>
                </div>
            </div>

            <h2>Startup Folder</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Startup Folder Persistence</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Files added to startup folders</span>
<span class="variable">DeviceFileEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FolderPath <span class="function">has_any</span> (
    <span class="string">"\\Start Menu\\Programs\\Startup"</span>,
    <span class="string">"\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\StartUp"</span>
)
<span class="operator">|</span> <span class="keyword">where</span> ActionType <span class="operator">==</span> <span class="string">"FileCreated"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, FolderPath, SHA256,
         InitiatingProcessFileName, AccountName

<span class="comment">// Shortcut files (.lnk) created in startup</span>
<span class="variable">DeviceFileEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FolderPath <span class="function">has</span> <span class="string">"\\Startup"</span>
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="function">endswith</span> <span class="string">".lnk"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, FolderPath,
         InitiatingProcessFileName</code></pre>
                </div>
            </div>

            <h2>WMI Persistence</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - WMI Event Subscriptions</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// WMI event subscription creation</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (
    <span class="string">"__EventFilter"</span>, <span class="string">"__EventConsumer"</span>, <span class="string">"__FilterToConsumerBinding"</span>,
    <span class="string">"CommandLineEventConsumer"</span>, <span class="string">"ActiveScriptEventConsumer"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, ProcessCommandLine, AccountName

<span class="comment">// WMI repository modifications</span>
<span class="variable">DeviceFileEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FolderPath <span class="function">has</span> <span class="string">"\\wbem\\Repository"</span>
<span class="operator">|</span> <span class="keyword">where</span> ActionType <span class="operator">==</span> <span class="string">"FileModified"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, FolderPath,
         InitiatingProcessFileName</code></pre>
                </div>
            </div>

            <h2>DLL Hijacking & COM Objects</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - DLL/COM Persistence</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// COM object hijacking</span>
<span class="variable">DeviceRegistryEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RegistryKey <span class="function">has</span> <span class="string">"\\CLSID\\"</span>
<span class="operator">|</span> <span class="keyword">where</span> RegistryKey <span class="function">has</span> <span class="string">"InprocServer32"</span>
<span class="operator">|</span> <span class="keyword">where</span> ActionType <span class="operator">==</span> <span class="string">"RegistryValueSet"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RegistryKey, RegistryValueData,
         InitiatingProcessFileName

<span class="comment">// AppInit_DLLs (legacy but still used)</span>
<span class="variable">DeviceRegistryEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> RegistryKey <span class="function">has</span> <span class="string">"\\Windows\\CurrentVersion\\Windows"</span>
<span class="operator">|</span> <span class="keyword">where</span> RegistryValueName <span class="operator">=~</span> <span class="string">"AppInit_DLLs"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, RegistryValueData, InitiatingProcessFileName</code></pre>
                </div>
            </div>

            <div class="callout tip">
                <div class="callout-icon">üí°</div>
                <div class="callout-content">
                    <h5>Persistence Hunting Tips</h5>
                    <ul>
                        <li><strong>Check timestamps</strong> - Recently created persistence is most suspicious</li>
                        <li><strong>Correlate with other activity</strong> - What happened before persistence was set?</li>
                        <li><strong>Baseline normal</strong> - Know what persistence exists in your environment</li>
                        <li><strong>MITRE ATT&CK</strong> - Map findings to T1547, T1053, T1543, T1546</li>
                    </ul>
                </div>
            </div>

            <!-- Interview Tips -->
            <div class="interview-tips">
                <h3>üí° Key Interview Points</h3>
                <ul>
                    <li><strong>Run keys</strong>: HKLM/HKCU CurrentVersion\Run and RunOnce</li>
                    <li><strong>Scheduled tasks</strong>: schtasks /create, Task Scheduler XML files</li>
                    <li><strong>Services</strong>: sc create, ImagePath registry values</li>
                    <li><strong>Startup folder</strong>: Start Menu\Programs\Startup</li>
                    <li><strong>WMI</strong>: EventFilter, EventConsumer, FilterToConsumerBinding</li>
                </ul>
            </div>

            <nav class="page-nav">
                <a href="5-6-hunting-queries-network.html" class="page-nav-link prev">
                    <span class="page-nav-label">‚Üê Previous</span>
                    <span class="page-nav-title">Network Hunting</span>
                </a>
                <a href="5-8-hunting-queries-credentials.html" class="page-nav-link next">
                    <span class="page-nav-label">Next ‚Üí</span>
                    <span class="page-nav-title">Credential Hunting</span>
                </a>
            </nav>
        </div>
    </main>

    <div class="search-modal">
        <div class="search-modal-content">
            <div class="search-modal-input-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-modal-input" placeholder="Search pages..." autofocus>
                <button class="search-modal-close">ESC</button>
            </div>
            <div class="search-results"></div>
        </div>
    </div>
    <script src="main.js"></script>
</body>
</html>
