<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credential Hunting Queries | MDE Ultimate Guide</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="mobile-menu-btn" aria-label="Toggle menu">‚ò∞</button>
            <a href="index.html" class="logo">
                <div class="logo-icon">MDE</div>
                <div class="logo-text"><span>MDE</span> Ultimate Guide</div>
            </a>
        </div>
        <div class="search-container">
            <button class="search-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <span>Search documentation...</span>
                <span class="search-shortcut"><kbd>‚åò</kbd><kbd>K</kbd></span>
            </button>
        </div>
        <div class="header-right">
            <a href="12-2-interview-questions.html" class="header-link">Interview Prep</a>
            <a href="5-3-kql-fundamentals.html" class="header-link">KQL Guide</a>
        </div>
    </header>

    <div class="sidebar-overlay"></div>
    <aside class="sidebar"></aside>

    <main class="main-content">
        <div class="content-wrapper">
            <div class="overview-box">
                <h4>üéØ What This Page Covers</h4>
                <p>Ready-to-use KQL hunting queries for detecting credential theft, credential dumping, and unauthorized authentication activities in your environment.</p>
            </div>

            <h1>Credential Hunting Queries</h1>

            <p>Credential theft is a critical attack phase that enables lateral movement and privilege escalation. These queries help detect common credential attack techniques.</p>

            <h2>LSASS Access Detection</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - LSASS Memory Access</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Suspicious processes accessing LSASS</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="operator">=~</span> <span class="string">"lsass.exe"</span>
<span class="operator">|</span> <span class="keyword">where</span> InitiatingProcessFileName <span class="operator">!in~</span> (
    <span class="string">"svchost.exe"</span>, <span class="string">"services.exe"</span>, <span class="string">"wininit.exe"</span>,
    <span class="string">"csrss.exe"</span>, <span class="string">"smss.exe"</span>, <span class="string">"lsm.exe"</span>,
    <span class="string">"MsMpEng.exe"</span>, <span class="string">"MsSense.exe"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, InitiatingProcessFileName,
         InitiatingProcessCommandLine, AccountName

<span class="comment">// LSASS memory dump via comsvcs.dll</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="operator">=~</span> <span class="string">"rundll32.exe"</span>
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_all</span> (<span class="string">"comsvcs"</span>, <span class="string">"MiniDump"</span>)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName

<span class="comment">// Procdump targeting LSASS</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="function">has_any</span> (<span class="string">"procdump"</span>, <span class="string">"procdump64"</span>)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has</span> <span class="string">"lsass"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName

<span class="comment">// Task Manager LSASS dump (creates lsass.DMP)</span>
<span class="variable">DeviceFileEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="operator">=~</span> <span class="string">"lsass.DMP"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FolderPath, InitiatingProcessFileName</code></pre>
                </div>
            </div>

            <h2>Mimikatz Detection</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Mimikatz Indicators</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Mimikatz command patterns</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (
    <span class="string">"sekurlsa"</span>,
    <span class="string">"logonpasswords"</span>,
    <span class="string">"kerberos::list"</span>,
    <span class="string">"kerberos::ptt"</span>,
    <span class="string">"lsadump"</span>,
    <span class="string">"dcsync"</span>,
    <span class="string">"privilege::debug"</span>,
    <span class="string">"token::elevate"</span>,
    <span class="string">"crypto::capi"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, ProcessCommandLine, AccountName

<span class="comment">// Mimikatz file indicators</span>
<span class="variable">DeviceFileEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="function">has_any</span> (
    <span class="string">"mimikatz"</span>,
    <span class="string">"mimilib"</span>,
    <span class="string">"mimidrv"</span>,
    <span class="string">"sekurlsa"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, FolderPath, ActionType

<span class="comment">// Mimikatz driver installation</span>
<span class="variable">DeviceEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> ActionType <span class="operator">==</span> <span class="string">"DriverLoad"</span>
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="function">has</span> <span class="string">"mimidrv"</span>
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, FolderPath</code></pre>
                </div>
            </div>

            <h2>Credential Dumping Tools</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Known Credential Tools</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Known credential dumping tools</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="function">has_any</span> (
    <span class="string">"mimikatz"</span>,
    <span class="string">"gsecdump"</span>,
    <span class="string">"wce.exe"</span>,
    <span class="string">"pwdump"</span>,
    <span class="string">"fgdump"</span>,
    <span class="string">"cachedump"</span>,
    <span class="string">"lsadump"</span>,
    <span class="string">"lazagne"</span>,
    <span class="string">"secretsdump"</span>,
    <span class="string">"pypykatz"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, ProcessCommandLine, AccountName, SHA256

<span class="comment">// Impacket secretsdump patterns</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (
    <span class="string">"secretsdump.py"</span>,
    <span class="string">"-just-dc"</span>,
    <span class="string">"-just-dc-ntlm"</span>,
    <span class="string">"ntds.dit"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName

<span class="comment">// LaZagne credential harvester</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (
    <span class="string">"lazagne"</span>,
    <span class="string">"all -oN"</span>,
    <span class="string">"browsers -oN"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName</code></pre>
                </div>
            </div>

            <h2>SAM/SYSTEM/SECURITY Hive Access</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Registry Hive Extraction</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Registry hive save commands (offline credential extraction)</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="operator">=~</span> <span class="string">"reg.exe"</span>
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has</span> <span class="string">"save"</span>
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (<span class="string">"sam"</span>, <span class="string">"system"</span>, <span class="string">"security"</span>)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName

<span class="comment">// Shadow copy access (Volume Shadow Copy credential extraction)</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_all</span> (<span class="string">"\\\\?\\"</span>, <span class="string">"GLOBALROOT"</span>, <span class="string">"Device"</span>)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (<span class="string">"sam"</span>, <span class="string">"system"</span>, <span class="string">"ntds"</span>)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName

<span class="comment">// NTDS.dit access attempts</span>
<span class="variable">DeviceFileEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="operator">=~</span> <span class="string">"ntds.dit"</span>
<span class="operator">|</span> <span class="keyword">where</span> ActionType <span class="function">in</span> (<span class="string">"FileCreated"</span>, <span class="string">"FileModified"</span>, <span class="string">"FileRenamed"</span>)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FolderPath, ActionType, 
         InitiatingProcessFileName, AccountName

<span class="comment">// Esentutl NTDS extraction</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="operator">=~</span> <span class="string">"esentutl.exe"</span>
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (<span class="string">"ntds"</span>, <span class="string">"sam"</span>, <span class="string">"/y"</span>, <span class="string">"/vss"</span>)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName</code></pre>
                </div>
            </div>

            <h2>Kerberos Attack Detection</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Kerberos Attacks</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Rubeus indicators</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (
    <span class="string">"rubeus"</span>,
    <span class="string">"kerberoast"</span>,
    <span class="string">"asreproast"</span>,
    <span class="string">"s4u"</span>,
    <span class="string">"createnetonly"</span>,
    <span class="string">"ptt /ticket"</span>,
    <span class="string">"harvest"</span>,
    <span class="string">"tgtdeleg"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName

<span class="comment">// Golden/Silver ticket indicators</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (
    <span class="string">"golden"</span>,
    <span class="string">"silver"</span>,
    <span class="string">"krbtgt"</span>,
    <span class="string">"/domain:"</span>,
    <span class="string">"/sid:"</span>,
    <span class="string">"/rc4:"</span>,
    <span class="string">"/aes256:"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName

<span class="comment">// Pass-the-Ticket detection</span>
<span class="variable">DeviceProcessEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> ProcessCommandLine <span class="function">has_any</span> (
    <span class="string">"ptt"</span>,
    <span class="string">"kerberos::ptt"</span>,
    <span class="string">"/ticket:"</span>,
    <span class="string">".kirbi"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, ProcessCommandLine, AccountName</code></pre>
                </div>
            </div>

            <h2>Browser Credential Access</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">KQL - Browser Credential Files</span>
                    <button class="code-copy">üìã Copy</button>
                </div>
                <div class="code-content">
<pre><code><span class="comment">// Browser credential file access by non-browser processes</span>
<span class="variable">DeviceFileEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FileName <span class="function">has_any</span> (
    <span class="string">"Login Data"</span>,
    <span class="string">"logins.json"</span>,
    <span class="string">"key3.db"</span>,
    <span class="string">"key4.db"</span>,
    <span class="string">"cookies.sqlite"</span>
)
<span class="operator">|</span> <span class="keyword">where</span> InitiatingProcessFileName <span class="operator">!in~</span> (
    <span class="string">"chrome.exe"</span>, <span class="string">"firefox.exe"</span>, <span class="string">"msedge.exe"</span>, <span class="string">"brave.exe"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FileName, FolderPath,
         InitiatingProcessFileName, AccountName

<span class="comment">// Windows credential store access</span>
<span class="variable">DeviceFileEvents</span>
<span class="operator">|</span> <span class="keyword">where</span> Timestamp <span class="operator">></span> <span class="function">ago</span>(<span class="number">7</span>d)
<span class="operator">|</span> <span class="keyword">where</span> FolderPath <span class="function">has_any</span> (
    <span class="string">"\\Microsoft\\Credentials\\"</span>,
    <span class="string">"\\Microsoft\\Protect\\"</span>,
    <span class="string">"\\Microsoft\\Vault\\"</span>
)
<span class="operator">|</span> <span class="keyword">where</span> InitiatingProcessFileName <span class="operator">!in~</span> (
    <span class="string">"lsass.exe"</span>, <span class="string">"svchost.exe"</span>, <span class="string">"explorer.exe"</span>
)
<span class="operator">|</span> <span class="keyword">project</span> Timestamp, DeviceName, FolderPath, FileName,
         InitiatingProcessFileName, AccountName</code></pre>
                </div>
            </div>

            <div class="callout warning">
                <div class="callout-icon">‚ö†Ô∏è</div>
                <div class="callout-content">
                    <h5>MITRE ATT&CK Mapping</h5>
                    <ul>
                        <li><strong>T1003.001</strong>: LSASS Memory</li>
                        <li><strong>T1003.002</strong>: SAM (Security Account Manager)</li>
                        <li><strong>T1003.003</strong>: NTDS (Domain Controller)</li>
                        <li><strong>T1558.003</strong>: Kerberoasting</li>
                        <li><strong>T1550.002</strong>: Pass the Hash</li>
                        <li><strong>T1550.003</strong>: Pass the Ticket</li>
                        <li><strong>T1555.003</strong>: Credentials from Web Browsers</li>
                    </ul>
                </div>
            </div>

            <!-- Interview Tips -->
            <div class="interview-tips">
                <h3>üí° Key Interview Points</h3>
                <ul>
                    <li><strong>LSASS</strong>: Contains cached credentials, primary target for dumping</li>
                    <li><strong>Mimikatz</strong>: Most common credential tool, sekurlsa::logonpasswords</li>
                    <li><strong>DCSync</strong>: Replicates credentials from DC without touching LSASS</li>
                    <li><strong>Kerberoasting</strong>: Requests service tickets to crack offline</li>
                    <li><strong>Pass-the-Hash</strong>: Uses NTLM hash instead of password</li>
                    <li><strong>SAM/SYSTEM</strong>: Registry hives containing local account hashes</li>
                </ul>
            </div>

            <nav class="page-nav">
                <a href="5-7-hunting-queries-persistence.html" class="page-nav-link prev">
                    <span class="page-nav-label">‚Üê Previous</span>
                    <span class="page-nav-title">Persistence Hunting Queries</span>
                </a>
                <a href="5-9-hunting-queries-malware.html" class="page-nav-link next">
                    <span class="page-nav-label">Next ‚Üí</span>
                    <span class="page-nav-title">Malware Hunting Queries</span>
                </a>
            </nav>
        </div>
    </main>

    <div class="search-modal">
        <div class="search-modal-content">
            <div class="search-modal-input-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-modal-input" placeholder="Search pages..." autofocus>
                <button class="search-modal-close">ESC</button>
            </div>
            <div class="search-results"></div>
        </div>
    </div>
    <script src="main.js"></script>
</body>
</html>
