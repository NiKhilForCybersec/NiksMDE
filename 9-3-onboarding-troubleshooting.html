<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Onboarding Troubleshooting | MDE Ultimate Guide</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="mobile-menu-btn" aria-label="Toggle menu">â˜°</button>
            <a href="index.html" class="logo">
                <div class="logo-icon">MDE</div>
                <div class="logo-text"><span>MDE</span> Ultimate Guide</div>
            </a>
        </div>
        <div class="search-container">
            <button class="search-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <span>Search documentation...</span>
                <span class="search-shortcut"><kbd>âŒ˜</kbd><kbd>K</kbd></span>
            </button>
        </div>
        <div class="header-right">
            <a href="12-2-interview-questions.html" class="header-link">Interview Prep</a>
            <a href="5-3-kql-fundamentals.html" class="header-link">KQL Guide</a>
        </div>
    </header>

    <div class="sidebar-overlay"></div>
    <aside class="sidebar"></aside>

    <main class="main-content">
        <div class="content-wrapper">
            <div class="overview-box">
                <h4>ğŸ¯ What This Page Covers</h4>
                <p>Complete troubleshooting guide for MDE onboarding issues. Diagnose and resolve common problems preventing devices from successfully onboarding to Microsoft Defender for Endpoint.</p>
            </div>

            <h1>Onboarding Troubleshooting</h1>

            <p>When devices fail to onboard to MDE, systematic troubleshooting is required. This guide covers common issues, diagnostic steps, and solutions for onboarding failures.</p>

            <h2>Onboarding Verification</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">Verification Commands</span>
                    <button class="code-copy">ğŸ“‹ Copy</button>
                </div>
                <div class="code-content">
<pre><code>STEP 1: CHECK ONBOARDING STATE

Registry Check:
<span class="function">reg query</span> <span class="string">"HKLM\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status"</span>

Expected Values:
â”œâ”€â”€ OnboardingState = 1 (Onboarded)
â”œâ”€â”€ OnboardingState = 0 (Not onboarded)
â””â”€â”€ OrgId = Your tenant ID

PowerShell:
<span class="function">Get-ItemProperty</span> <span class="string">"HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status"</span>

STEP 2: CHECK SENSE SERVICE

Command Prompt:
<span class="function">sc query</span> sense

Expected:
â”œâ”€â”€ STATE: RUNNING
â””â”€â”€ If not running: sc start sense

PowerShell:
<span class="function">Get-Service</span> <span class="variable">-Name</span> Sense

STEP 3: CHECK EVENT LOGS

Event Viewer Path:
Applications and Services Logs â†’ Microsoft â†’ Windows â†’ SENSE â†’ Operational

Key Events:
â”œâ”€â”€ Event 1: Service started successfully
â”œâ”€â”€ Event 4: Service stopped
â”œâ”€â”€ Event 5: Failed to connect to cloud
â”œâ”€â”€ Event 15: Onboarding failed
â””â”€â”€ Event 25: Registration successful

PowerShell:
<span class="function">Get-WinEvent</span> <span class="variable">-LogName</span> <span class="string">"Microsoft-Windows-SENSE/Operational"</span> <span class="operator">|</span> 
    <span class="function">Select-Object</span> <span class="variable">-First</span> <span class="number">20</span> TimeCreated, Id, Message</code></pre>
                </div>
            </div>

            <h2>Common Onboarding Issues</h2>

            <div class="flow-diagram">
                <div class="diagram-title">Onboarding Troubleshooting Decision Tree</div>
<pre>
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ONBOARDING TROUBLESHOOTING                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Device not appearing in portal?                                        â”‚
â”‚            â”‚                                                             â”‚
â”‚            â–¼                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ Check OnboardingStateâ”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚             â”‚                                                            â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                                                    â”‚
â”‚      â–¼             â–¼                                                    â”‚
â”‚  State = 0      State = 1                                               â”‚
â”‚  (Not onboarded) (Onboarded)                                            â”‚
â”‚      â”‚             â”‚                                                    â”‚
â”‚      â–¼             â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚Run      â”‚   â”‚Check        â”‚                                         â”‚
â”‚  â”‚onboardingâ”‚   â”‚connectivity â”‚                                         â”‚
â”‚  â”‚script   â”‚   â”‚to cloud     â”‚                                         â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚       â”‚               â”‚                                                 â”‚
â”‚       â–¼               â–¼                                                 â”‚
â”‚  Still fails?    Can't connect?                                         â”‚
â”‚       â”‚               â”‚                                                 â”‚
â”‚       â–¼               â–¼                                                 â”‚
â”‚  Check:          Check:                                                 â”‚
â”‚  â€¢ Admin rights  â€¢ Firewall/Proxy                                       â”‚
â”‚  â€¢ OS version    â€¢ URL allowlist                                        â”‚
â”‚  â€¢ Conflicts     â€¢ Certificates                                         â”‚
â”‚  â€¢ Event logs    â€¢ DNS resolution                                       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</pre>
            </div>

            <h2>Issue: Device Not Appearing in Portal</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">Troubleshooting Steps</span>
                    <button class="code-copy">ğŸ“‹ Copy</button>
                </div>
                <div class="code-content">
<pre><code>PROBLEM: Device onboarded but not visible in portal

POSSIBLE CAUSES:
â”œâ”€â”€ Device still syncing (wait 20-30 minutes)
â”œâ”€â”€ Connectivity issues to cloud
â”œâ”€â”€ Device in wrong tenant
â”œâ”€â”€ Duplicate device entries
â””â”€â”€ Portal filtering hiding device

SOLUTIONS:

1. WAIT FOR SYNC
   â””â”€â”€ New devices can take 20-30 minutes to appear
   â””â”€â”€ Check back after 30 minutes

2. VERIFY CORRECT TENANT
   <span class="function">reg query</span> <span class="string">"HKLM\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status"</span> <span class="variable">/v</span> OrgId
   â””â”€â”€ Compare OrgId with your tenant ID in portal
   â””â”€â”€ If wrong, offboard and re-onboard with correct package

3. CHECK CONNECTIVITY
   â””â”€â”€ Run MDEClientAnalyzer
   â””â”€â”€ Test cloud endpoints manually
   â””â”€â”€ Verify proxy settings

4. RUN DETECTION TEST
   <span class="comment"># PowerShell detection test</span>
   powershell.exe <span class="variable">-NoExit</span> <span class="variable">-ExecutionPolicy</span> Bypass <span class="variable">-WindowStyle</span> Hidden <span class="string">"$ErrorActionPreference= 'silentlycontinue';(New-Object System.Net.WebClient).DownloadString('https://winatp-gw-cus.microsoft.com/test') | Out-Null"</span>
   â””â”€â”€ Should generate test alert within 10-20 minutes

5. CHECK PORTAL FILTERS
   â””â”€â”€ Remove all filters in Device Inventory
   â””â”€â”€ Search by device name directly
   â””â”€â”€ Check "All devices" not just "Computers"</code></pre>
                </div>
            </div>

            <h2>Issue: Onboarding Script Fails</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">Script Failure Troubleshooting</span>
                    <button class="code-copy">ğŸ“‹ Copy</button>
                </div>
                <div class="code-content">
<pre><code>PROBLEM: Onboarding script returns error

ERROR: "Access Denied"
SOLUTION:
â”œâ”€â”€ Run as Administrator
â”œâ”€â”€ Check UAC settings
â””â”€â”€ Verify account has local admin rights

ERROR: "Script execution is disabled"
SOLUTION:
â”œâ”€â”€ Set-ExecutionPolicy RemoteSigned -Scope Process
â”œâ”€â”€ Or run: powershell -ExecutionPolicy Bypass -File script.ps1
â””â”€â”€ Check Group Policy for script restrictions

ERROR: "Cannot connect to server"
SOLUTION:
â”œâ”€â”€ Check internet connectivity
â”œâ”€â”€ Verify proxy settings
â”œâ”€â”€ Test MDE URLs manually
â””â”€â”€ Check firewall rules

ERROR: "Onboarding blob invalid"
SOLUTION:
â”œâ”€â”€ Download fresh onboarding package
â”œâ”€â”€ Package may have expired
â”œâ”€â”€ Verify correct package for deployment method
â””â”€â”€ Check for file corruption during download

ERROR: "Service failed to start"
SOLUTION:
â”œâ”€â”€ Check Windows Defender service status
â”œâ”€â”€ Verify no conflicting AV software
â”œâ”€â”€ Check for corrupted Windows components
â””â”€â”€ Run: sfc /scannow

GENERAL TROUBLESHOOTING:
1. Check event logs for specific error
2. Run MDEClientAnalyzer for diagnostics
3. Verify OS version is supported
4. Check for pending reboots
5. Ensure Windows is activated</code></pre>
                </div>
            </div>

            <h2>Issue: Sense Service Not Starting</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">Service Troubleshooting</span>
                    <button class="code-copy">ğŸ“‹ Copy</button>
                </div>
                <div class="code-content">
<pre><code>PROBLEM: Sense service won't start or keeps stopping

CHECK SERVICE STATUS:
<span class="function">sc query</span> sense
<span class="function">sc qc</span> sense  <span class="comment"># Show configuration</span>

COMMON CAUSES:

1. DEPENDENCIES NOT RUNNING
   Required services:
   â”œâ”€â”€ Windows Defender Antivirus Service (WinDefend)
   â”œâ”€â”€ Windows Defender Advanced Threat Protection (Sense)
   â””â”€â”€ Diagnostic Tracking Service (DiagTrack)
   
   Check all: <span class="function">sc query</span> WinDefend && <span class="function">sc query</span> DiagTrack

2. THIRD-PARTY AV CONFLICT
   â”œâ”€â”€ Some AV products disable Sense
   â”œâ”€â”€ Check AV exclusions for MDE
   â””â”€â”€ May need to uninstall conflicting AV

3. GROUP POLICY BLOCKING
   â”œâ”€â”€ Check for policies disabling Defender
   â””â”€â”€ HKLM\SOFTWARE\Policies\Microsoft\Windows Defender
   â””â”€â”€ DisableAntiSpyware should NOT be 1

4. CORRUPTED INSTALLATION
   Solution:
   â”œâ”€â”€ Run: DISM /Online /Cleanup-Image /RestoreHealth
   â”œâ”€â”€ Run: sfc /scannow
   â””â”€â”€ Re-run onboarding script

5. MISSING PREREQUISITES
   Windows 10/11:
   â”œâ”€â”€ KB required for older versions
   â””â”€â”€ Check Windows Update for pending updates

   Windows Server:
   â”œâ”€â”€ Install Microsoft Monitoring Agent if needed
   â””â”€â”€ Enable required Windows features

MANUAL SERVICE START:
<span class="function">sc start</span> sense
<span class="comment"># If fails, check Event Viewer for specific error</span></code></pre>
                </div>
            </div>

            <h2>Issue: Connectivity Problems</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">Connectivity Fixes</span>
                    <button class="code-copy">ğŸ“‹ Copy</button>
                </div>
                <div class="code-content">
<pre><code>PROBLEM: Device can't reach MDE cloud services

QUICK CONNECTIVITY TEST:
<span class="function">Invoke-WebRequest</span> <span class="string">"https://x.cp.wd.microsoft.com/api/report"</span> <span class="variable">-UseBasicParsing</span>
<span class="comment"># Should return 200 OK</span>

COMMON FIXES:

1. CONFIGURE PROXY
   <span class="comment"># Set system proxy</span>
   <span class="function">netsh winhttp set proxy</span> proxy-server=<span class="string">"http://proxy:8080"</span>
   
   <span class="comment"># Or import from IE</span>
   <span class="function">netsh winhttp import proxy</span> source=ie

2. ALLOW REQUIRED URLS
   Must allow outbound HTTPS (443) to:
   â”œâ”€â”€ *.securitycenter.windows.com
   â”œâ”€â”€ *.wdcp.microsoft.com
   â”œâ”€â”€ *.wd.microsoft.com
   â”œâ”€â”€ *.events.data.microsoft.com
   â””â”€â”€ *.blob.core.windows.net

3. EXEMPT FROM SSL INSPECTION
   â”œâ”€â”€ MDE URLs should bypass SSL inspection
   â”œâ”€â”€ Or trust inspection CA on endpoints
   â””â”€â”€ Test after making changes

4. CHECK DNS RESOLUTION
   <span class="function">nslookup</span> winatp-gw-cus.microsoft.com
   <span class="function">nslookup</span> x.cp.wd.microsoft.com
   â””â”€â”€ Should resolve to valid IPs

5. VERIFY TLS VERSION
   <span class="comment"># Enable TLS 1.2</span>
   [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

RUN FULL DIAGNOSTICS:
1. Download MDEClientAnalyzer from aka.ms/MDEClientAnalyzer
2. Extract and run as Administrator
3. Review results for specific issues
4. Follow remediation steps provided</code></pre>
                </div>
            </div>

            <h2>MDEClientAnalyzer Tool</h2>

            <div class="code-block">
                <div class="code-header">
                    <span class="code-lang">Using the Analyzer</span>
                    <button class="code-copy">ğŸ“‹ Copy</button>
                </div>
                <div class="code-content">
<pre><code>MDEClientAnalyzer - OFFICIAL DIAGNOSTIC TOOL

DOWNLOAD:
https://aka.ms/MDEClientAnalyzer

USAGE:
1. Download MDEClientAnalyzer.zip
2. Extract to local folder
3. Run Command Prompt as Administrator
4. Navigate to extracted folder
5. Run: MDEClientAnalyzer.cmd
6. Wait for analysis to complete (5-10 minutes)
7. Review results in MDEClientAnalyzerResult folder

OUTPUT FILES:
â”œâ”€â”€ MDEClientAnalyzer.htm    - Summary report (open this first)
â”œâ”€â”€ Connectivity results      - URL test results
â”œâ”€â”€ Event logs               - Relevant Windows events
â”œâ”€â”€ Configuration dump       - Registry and settings
â”œâ”€â”€ Recommendations          - Suggested fixes
â””â”€â”€ Logs for support         - For escalation to Microsoft

WHAT IT CHECKS:
â”œâ”€â”€ Onboarding status
â”œâ”€â”€ Service health
â”œâ”€â”€ Cloud connectivity (all URLs)
â”œâ”€â”€ Proxy configuration
â”œâ”€â”€ Certificate chain validation
â”œâ”€â”€ DNS resolution
â”œâ”€â”€ TLS configuration
â”œâ”€â”€ Firewall rules
â”œâ”€â”€ Third-party AV detection
â”œâ”€â”€ Windows version compatibility
â””â”€â”€ Known issues detection

INTERPRETING RESULTS:
â”œâ”€â”€ Green = Passed
â”œâ”€â”€ Yellow = Warning (may cause issues)
â”œâ”€â”€ Red = Failed (blocking issue)
â””â”€â”€ Follow recommendations for each failed check</code></pre>
                </div>
            </div>

            <div class="callout warning">
                <div class="callout-icon">âš ï¸</div>
                <div class="callout-content">
                    <h5>Important Notes</h5>
                    <ul>
                        <li><strong>Always run as Administrator</strong> for accurate results</li>
                        <li><strong>Wait 30 minutes</strong> after onboarding before troubleshooting</li>
                        <li><strong>Check for pending reboots</strong> - some changes require restart</li>
                        <li><strong>Download fresh packages</strong> - onboarding packages can expire</li>
                    </ul>
                </div>
            </div>

            <!-- Day-to-Day Section -->
            <div class="day-to-day">
                <h3>ğŸ”§ Security Engineer Day-to-Day Tasks</h3>
                
                <h4>Onboarding Support</h4>
                <ul>
                    <li>Troubleshoot devices failing to onboard</li>
                    <li>Run MDEClientAnalyzer on problem devices</li>
                    <li>Work with network team on connectivity issues</li>
                    <li>Document common issues and solutions</li>
                    <li>Escalate complex issues to Microsoft support</li>
                </ul>

                <h4>Common Scenarios</h4>
                <div class="ticket-item">
                    <span class="ticket-type">"Device not appearing after onboarding"</span>
                    <span class="ticket-solution">â†’ Check OnboardingState, verify OrgId, test connectivity, wait 30 min.</span>
                </div>
                <div class="ticket-item">
                    <span class="ticket-type">"Onboarding script errors out"</span>
                    <span class="ticket-solution">â†’ Run as admin, check execution policy, verify OS version, check event logs.</span>
                </div>
                <div class="ticket-item">
                    <span class="ticket-type">"Sense service keeps stopping"</span>
                    <span class="ticket-solution">â†’ Check for AV conflicts, verify dependencies, run sfc /scannow.</span>
                </div>
            </div>

            <!-- Interview Tips -->
            <div class="interview-tips">
                <h3>ğŸ’¡ Key Interview Points</h3>
                <ul>
                    <li><strong>First check</strong>: OnboardingState registry value (1 = onboarded)</li>
                    <li><strong>Key service</strong>: Sense (sc query sense)</li>
                    <li><strong>Diagnostic tool</strong>: MDEClientAnalyzer from aka.ms/MDEClientAnalyzer</li>
                    <li><strong>Event logs</strong>: Microsoft-Windows-SENSE/Operational</li>
                    <li><strong>Common issues</strong>: Connectivity, proxy, AV conflicts, admin rights</li>
                    <li><strong>Wait time</strong>: Devices can take 20-30 minutes to appear in portal</li>
                </ul>
            </div>

            <nav class="page-nav">
                <a href="9-2-connectivity-troubleshooting.html" class="page-nav-link prev">
                    <span class="page-nav-label">â† Previous</span>
                    <span class="page-nav-title">Connectivity Troubleshooting</span>
                </a>
                <a href="9-4-performance-issues.html" class="page-nav-link next">
                    <span class="page-nav-label">Next â†’</span>
                    <span class="page-nav-title">Performance Issues</span>
                </a>
            </nav>
        </div>
    </main>

    <div class="search-modal">
        <div class="search-modal-content">
            <div class="search-modal-input-wrapper">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="M21 21l-4.35-4.35"></path>
                </svg>
                <input type="text" class="search-modal-input" placeholder="Search pages..." autofocus>
                <button class="search-modal-close">ESC</button>
            </div>
            <div class="search-results"></div>
        </div>
    </div>
    <script src="main.js"></script>
</body>
</html>
