<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Troubleshooting - MDE Ultimate Guide</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="navbar-brand"><span class="brand-icon">ğŸ›¡ï¸</span><span>MDE Ultimate Guide</span></a>
            <button class="navbar-toggle">â˜°</button>
            <ul class="navbar-nav">
                <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
                <li class="nav-item"><a href="architecture.html" class="nav-link">Architecture</a></li>
                <li class="nav-item"><a href="deployment.html" class="nav-link">Deployment</a></li>
                <li class="nav-item"><a href="features.html" class="nav-link">Features</a></li>
                <li class="nav-item"><a href="tvm.html" class="nav-link">TVM</a></li>
                <li class="nav-item"><a href="asr-rules.html" class="nav-link">ASR Rules</a></li>
                <li class="nav-item"><a href="analyst-engineer.html" class="nav-link">Analyst vs Engineer</a></li>
                <li class="nav-item"><a href="troubleshooting.html" class="nav-link active">Troubleshooting</a></li>
                <li class="nav-item"><a href="licensing.html" class="nav-link">Licensing & Comparison</a></li>
                <li class="nav-item"><a href="kql-rules.html" class="nav-link">KQL Rules</a></li>
                <li class="nav-item"><a href="use-cases.html" class="nav-link">Use Cases</a></li>
                <li class="nav-item"><a href="automation.html" class="nav-link">Automation</a></li>
                <li class="nav-item"><a href="best-practices.html" class="nav-link">Best Practices</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-container">
        <div class="content-wrapper">
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <div class="sidebar-title">On This Page</div>
                    <ul class="sidebar-links">
                        <li><a href="#overview">Overview</a></li>
                        <li><a href="#sensor-health">Sensor Health Issues</a></li>
                        <li><a href="#connectivity">Connectivity Problems</a></li>
                        <li><a href="#onboarding">Onboarding Failures</a></li>
                        <li><a href="#client-analyzer">MDE Client Analyzer</a></li>
                        <li><a href="#defender-av">Defender AV Issues</a></li>
                        <li><a href="#portal-issues">Portal Issues</a></li>
                        <li><a href="#common-errors">Common Error Codes</a></li>
                        <li><a href="#escalation">Escalation Path</a></li>
                    </ul>
                </nav>
            </aside>

            <div class="content">
                <h1>ğŸ”§ Troubleshooting Guide</h1>
                <p class="section-desc">Comprehensive troubleshooting for MDE sensor issues, connectivity problems, and common errors.</p>

                <section id="overview">
                    <h2>Troubleshooting Workflow</h2>
                    <div class="diagram-container">
                        <div class="diagram-title">MDE Troubleshooting Decision Tree</div>
                        <pre style="font-family: var(--font-mono); font-size: 0.7rem; line-height: 1.2; color: var(--text-secondary);">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       MDE TROUBLESHOOTING WORKFLOW                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   Device Not Reporting?                                                          â”‚
â”‚         â”‚                                                                        â”‚
â”‚         â–¼                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     No      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚ Is device   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Check Intuneâ”‚                                   â”‚
â”‚   â”‚ onboarded?  â”‚             â”‚ deployment  â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚          â”‚ Yes                                                                   â”‚
â”‚          â–¼                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     No      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚ Sense svc   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Start Sense â”‚                                   â”‚
â”‚   â”‚ running?    â”‚             â”‚ service     â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚          â”‚ Yes                                                                   â”‚
â”‚          â–¼                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     No      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚   â”‚ Can reach   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Check proxy â”‚                                   â”‚
â”‚   â”‚ cloud URLs? â”‚             â”‚ & firewall  â”‚                                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚          â”‚ Yes                                                                   â”‚
â”‚          â–¼                                                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                               â”‚
â”‚   â”‚ Run Client  â”‚                                                               â”‚
â”‚   â”‚ Analyzer    â”‚                                                               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        </pre>
                    </div>
                </section>

                <section id="sensor-health">
                    <h2>Sensor Health Issues</h2>
                    
                    <h3>Check Sensor Status</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Sensor Health Check</span><button class="code-copy">Copy</button></div>
                        <pre><code># Check MDE Sense service status
Get-Service Sense | Select-Object Name, Status, StartType

# Check WinDefend service
Get-Service WinDefend | Select-Object Name, Status, StartType

# Get MDE configuration
Get-MpComputerStatus | Select-Object AMRunningMode, AntivirusEnabled, 
    RealTimeProtectionEnabled, OnAccessProtectionEnabled

# Check onboarding status
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status" | 
    Select-Object OnboardingState, OrgId

# OnboardingState: 1 = Onboarded, 0 = Not onboarded</code></pre>
                    </div>

                    <h3>Common Sensor States</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Status</th><th>Meaning</th><th>Action</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td><span class="badge badge-success">Active</span></td>
                                    <td>Sensor healthy and reporting</td>
                                    <td>No action needed</td>
                                </tr>
                                <tr>
                                    <td><span class="badge badge-warning">Inactive</span></td>
                                    <td>No data in 7+ days</td>
                                    <td>Check device is online, verify services</td>
                                </tr>
                                <tr>
                                    <td><span class="badge badge-danger">Misconfigured</span></td>
                                    <td>Sensor has configuration issues</td>
                                    <td>Re-run onboarding, check policies</td>
                                </tr>
                                <tr>
                                    <td><span class="badge badge-secondary">No sensor data</span></td>
                                    <td>Device never reported</td>
                                    <td>Verify onboarding completed</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>Restart Sensor Services</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Service Restart</span><button class="code-copy">Copy</button></div>
                        <pre><code># Restart MDE Sense service (requires elevation)
Restart-Service Sense -Force

# Restart Windows Defender service
Restart-Service WinDefend -Force

# Force sensor re-registration
Stop-Service Sense
Remove-Item "C:\ProgramData\Microsoft\Windows Defender Advanced Threat Protection\Cyber" -Recurse -Force
Start-Service Sense</code></pre>
                    </div>
                </section>

                <section id="connectivity">
                    <h2>Connectivity Problems</h2>
                    
                    <h3>Required URLs</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Required MDE Cloud URLs</span><button class="code-copy">Copy</button></div>
                        <pre><code># Core MDE URLs (must be accessible)
*.securitycenter.windows.com          # Portal
*.security.microsoft.com              # M365 Defender
winatp-gw-cus.microsoft.com          # Gateway (varies by region)
winatp-gw-eus.microsoft.com          
winatp-gw-weu.microsoft.com
*.blob.core.windows.net               # Sample upload
*.ods.opinsights.azure.com           # Log Analytics
*.oms.opinsights.azure.com

# CRL/OCSP for certificate validation  
crl.microsoft.com
ctldl.windowsupdate.com
www.microsoft.com/pkiops</code></pre>
                    </div>

                    <h3>Test Connectivity</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Connectivity Test</span><button class="code-copy">Copy</button></div>
                        <pre><code># Test core MDE connectivity
$urls = @(
    "https://winatp-gw-cus.microsoft.com/test",
    "https://winatp-gw-eus.microsoft.com/test",
    "https://security.microsoft.com",
    "https://login.microsoftonline.com"
)

foreach ($url in $urls) {
    try {
        $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
        Write-Host "âœ“ $url - Status: $($response.StatusCode)" -ForegroundColor Green
    } catch {
        Write-Host "âœ— $url - Error: $($_.Exception.Message)" -ForegroundColor Red
    }
}

# Test with proxy (if used)
$proxy = "http://proxy.company.com:8080"
Invoke-WebRequest -Uri "https://winatp-gw-cus.microsoft.com/test" -Proxy $proxy</code></pre>
                    </div>

                    <div class="alert alert-info">
                        <div class="alert-icon">ğŸ’¡</div>
                        <div class="alert-content">
                            <div class="alert-title">Proxy Configuration</div>
                            <p>If using a proxy, ensure WinHTTP proxy is configured: <code>netsh winhttp set proxy proxy.company.com:8080</code></p>
                        </div>
                    </div>
                </section>

                <section id="onboarding">
                    <h2>Onboarding Failures</h2>
                    
                    <h3>Verify Onboarding</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Onboarding Verification</span><button class="code-copy">Copy</button></div>
                        <pre><code># Check onboarding registry keys
$atp = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection\Status" -ErrorAction SilentlyContinue
if ($atp) {
    Write-Host "OnboardingState: $($atp.OnboardingState)"  # 1 = Success
    Write-Host "OrgId: $($atp.OrgId)"
    Write-Host "SenseIsRunning: $($atp.SenseIsRunning)"
} else {
    Write-Host "Device not onboarded - registry key missing"
}

# Check onboarding event log
Get-WinEvent -LogName "Microsoft-Windows-SENSE/Operational" -MaxEvents 20 | 
    Format-Table TimeCreated, Id, Message -Wrap</code></pre>
                    </div>

                    <h3>Re-onboard Device</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Manual Onboarding</span><button class="code-copy">Copy</button></div>
                        <pre><code># 1. Download onboarding package from security.microsoft.com
# Settings â†’ Endpoints â†’ Onboarding â†’ Download package

# 2. Run the onboarding script (from downloaded package)
.\WindowsDefenderATPOnboardingScript.cmd

# 3. Verify onboarding succeeded
$sense = Get-Service Sense
if ($sense.Status -eq "Running") {
    Write-Host "Sense service running" -ForegroundColor Green
}

# Force immediate check-in
Start-Process "C:\Program Files\Windows Defender Advanced Threat Protection\MsSense.exe" -ArgumentList "-c"</code></pre>
                    </div>

                    <h3>Offboard and Re-onboard</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Clean Re-onboard</span><button class="code-copy">Copy</button></div>
                        <pre><code># 1. Run offboarding script first
.\WindowsDefenderATPOffboardingScript.cmd

# 2. Wait for offboarding to complete (check portal)
Start-Sleep -Seconds 60

# 3. Clean up remnants
Stop-Service Sense -Force
Remove-Item "HKLM:\SOFTWARE\Microsoft\Windows Advanced Threat Protection" -Recurse -Force
Remove-Item "C:\ProgramData\Microsoft\Windows Defender Advanced Threat Protection\Cyber" -Recurse -Force

# 4. Re-onboard
.\WindowsDefenderATPOnboardingScript.cmd
Start-Service Sense</code></pre>
                    </div>
                </section>

                <section id="client-analyzer">
                    <h2>MDE Client Analyzer</h2>
                    
                    <div class="card">
                        <div class="card-body">
                            <p>The <strong>MDE Client Analyzer</strong> is Microsoft's official diagnostic tool for troubleshooting MDE sensor issues. It collects logs, tests connectivity, and provides actionable recommendations.</p>
                        </div>
                    </div>

                    <h3>Download and Run</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Client Analyzer</span><button class="code-copy">Copy</button></div>
                        <pre><code># Download MDE Client Analyzer
$analyzerUrl = "https://aka.ms/MDEAnalyzer"
$outputPath = "C:\Temp\MDEClientAnalyzer.zip"
Invoke-WebRequest -Uri $analyzerUrl -OutFile $outputPath

# Extract
Expand-Archive -Path $outputPath -DestinationPath "C:\Temp\MDEClientAnalyzer"

# Run analyzer (elevated PowerShell)
cd "C:\Temp\MDEClientAnalyzer"
.\MDEClientAnalyzer.cmd

# Results are saved to MDEClientAnalyzerResult folder
# Review MDEClientAnalyzer.htm for detailed report</code></pre>
                    </div>

                    <h3>What Client Analyzer Checks</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Category</th><th>Checks Performed</th></tr></thead>
                            <tbody>
                                <tr><td><strong>Connectivity</strong></td><td>Cloud URL reachability, proxy settings, certificates</td></tr>
                                <tr><td><strong>Services</strong></td><td>Sense service status, WinDefend status, dependencies</td></tr>
                                <tr><td><strong>Configuration</strong></td><td>Registry settings, policy conflicts, onboarding state</td></tr>
                                <tr><td><strong>Events</strong></td><td>Relevant event logs, error patterns</td></tr>
                                <tr><td><strong>System</strong></td><td>OS version, hotfixes, disk space, memory</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-success">
                        <div class="alert-icon">âœ…</div>
                        <div class="alert-content">
                            <div class="alert-title">Best Practice</div>
                            <p>Always run Client Analyzer before opening a support case. Attach the results ZIP file to your ticket.</p>
                        </div>
                    </div>
                </section>

                <section id="defender-av">
                    <h2>Defender AV Issues</h2>
                    
                    <h3>AV Not Updating</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Definition Updates</span><button class="code-copy">Copy</button></div>
                        <pre><code># Check current definition version
Get-MpComputerStatus | Select-Object AntivirusSignatureVersion, 
    AntivirusSignatureLastUpdated, AntispywareSignatureLastUpdated

# Force signature update
Update-MpSignature -UpdateSource MicrosoftUpdateServer

# If WSUS is used
Update-MpSignature -UpdateSource MMPC

# Check update history
Get-MpComputerStatus | Select-Object *SignatureLastUpdated*</code></pre>
                    </div>

                    <h3>Real-Time Protection Disabled</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Enable RTP</span><button class="code-copy">Copy</button></div>
                        <pre><code># Check RTP status
Get-MpComputerStatus | Select-Object RealTimeProtectionEnabled, 
    IoavProtectionEnabled, BehaviorMonitorEnabled

# Enable Real-Time Protection (if allowed by policy)
Set-MpPreference -DisableRealtimeMonitoring $false

# If tamper protection is on, this must be done via Intune/Portal
# Check tamper protection status
Get-MpComputerStatus | Select-Object IsTamperProtected</code></pre>
                    </div>

                    <h3>Passive Mode Issues</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">PowerShell - Check AV Mode</span><button class="code-copy">Copy</button></div>
                        <pre><code># Check if Defender is in passive mode
$status = Get-MpComputerStatus
Write-Host "AMRunningMode: $($status.AMRunningMode)"
# Normal = Active mode
# Passive = Third-party AV installed
# SxS Passive = Side-by-side passive (EDR only)

# Force active mode (remove third-party AV first)
Set-MpPreference -DisableRealtimeMonitoring $false</code></pre>
                    </div>
                </section>

                <section id="portal-issues">
                    <h2>Portal Issues</h2>
                    
                    <h3>Device Not Appearing in Portal</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Issue</th><th>Cause</th><th>Solution</th></tr></thead>
                            <tbody>
                                <tr>
                                    <td>Device never appears</td>
                                    <td>Onboarding failed</td>
                                    <td>Run onboarding script, check event logs</td>
                                </tr>
                                <tr>
                                    <td>Device appears then disappears</td>
                                    <td>Connectivity issues</td>
                                    <td>Check firewall/proxy, run connectivity test</td>
                                </tr>
                                <tr>
                                    <td>Duplicate devices</td>
                                    <td>Re-imaged without offboarding</td>
                                    <td>Merge devices in portal or delete old entries</td>
                                </tr>
                                <tr>
                                    <td>Wrong org showing</td>
                                    <td>Onboarded to different tenant</td>
                                    <td>Offboard and re-onboard with correct package</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>Alerts Not Generating</h3>
                    <div class="code-block">
                        <div class="code-header"><span class="code-lang">Troubleshooting Steps</span></div>
                        <pre><code># 1. Verify EDR is enabled (P2 license required for full EDR)
Get-MpComputerStatus | Select-Object AMRunningMode

# 2. Check if device is sending telemetry
# Run a test detection - EICAR test file
Invoke-WebRequest -Uri "https://secure.eicar.org/eicar.com.txt" -OutFile "C:\Temp\eicar.com"

# 3. Wait 15-30 minutes for alert to appear
# 4. Check Advanced Hunting for device events
# DeviceProcessEvents | where DeviceName == "YOURDEVICE" | take 10</code></pre>
                    </div>
                </section>

                <section id="common-errors">
                    <h2>Common Error Codes</h2>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Error Code</th><th>Description</th><th>Resolution</th></tr></thead>
                            <tbody>
                                <tr><td><code>0x80070005</code></td><td>Access denied</td><td>Run as administrator</td></tr>
                                <tr><td><code>0x8007000E</code></td><td>Out of memory</td><td>Free up system memory, restart</td></tr>
                                <tr><td><code>0x80072EE7</code></td><td>Server name not resolved</td><td>Check DNS, verify URLs accessible</td></tr>
                                <tr><td><code>0x80072EFD</code></td><td>Connection failed</td><td>Check firewall/proxy settings</td></tr>
                                <tr><td><code>0x80072F8F</code></td><td>Certificate error</td><td>Check system time, update root certs</td></tr>
                                <tr><td><code>0x800705B4</code></td><td>Timeout</td><td>Network latency, check connectivity</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <section id="escalation">
                    <h2>Escalation Path</h2>
                    <div class="card">
                        <div class="card-body">
                            <ol>
                                <li><strong>Self-Service:</strong> Run MDE Client Analyzer, review results</li>
                                <li><strong>Documentation:</strong> Check Microsoft Learn docs</li>
                                <li><strong>Community:</strong> Microsoft Tech Community forums</li>
                                <li><strong>Support Ticket:</strong> Open case via M365 Admin Center</li>
                                <li><strong>Premier Support:</strong> For critical issues with SLA</li>
                            </ol>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <div class="alert-icon">ğŸ“</div>
                        <div class="alert-content">
                            <div class="alert-title">Opening Support Cases</div>
                            <p>Include: Client Analyzer results, device name, org ID, timeline of issue, steps already tried.</p>
                        </div>
                    </div>
                </section>

                <div class="flex-between mt-4">
                    <a href="analyst-engineer.html" class="btn btn-secondary">â† Analyst vs Engineer</a>
                    <a href="licensing.html" class="btn btn-primary">Licensing â†’</a>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">MDE Ultimate Guide | For Security Analysts & Engineers</p>
        </div>
    </footer>
    <script src="js/main.js"></script>
</body>
</html>
